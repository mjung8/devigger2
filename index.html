<html>

<head>
    <title>Ice Cream Picker</title>
    <meta charset="utf-8">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
    <link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css" />
    <link rel="stylesheet" href="assets/css/styles.css" />
    <script defer src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz" crossorigin="anonymous"></script>
    <script defer src="https://pyscript.net/latest/pyscript.js"></script>
    <script defer src="assets/js/main.js"></script>
</head>

<body>

    <py-config>
        packages = ["numpy", "scipy"]
    </py-config>

    <py-script>
        import js
        import numpy as np

        from pyodide.ffi import create_proxy
        from pyodide.ffi import to_js
        from scipy.optimize import bisect

        def _get_shin_implied_probabilities(z, pi):
            normalization = sum(pi)
            return ((z ** 2 + 4 * (1 - z) * pi ** 2 / normalization) ** 0.5 - z) / (2 - 2 * z)


        def _get_shin_normalization(z, pi):
            implied_probabilities = _get_shin_implied_probabilities(z, pi)
            return 1 - sum(implied_probabilities)


        def _get_power_normalization(k, pi):
            implied_probabilities = pi ** k
            return 1 - sum(implied_probabilities)


        def calculate_multiplicative_probability(args):
            odds = np.array(args.to_py())
            pi = 1 / odds

            normalization = np.sum(pi, axis=1, keepdims=True)
            implied_probabilities = pi / normalization

            return implied_probabilities


        def calculate_additive_probability(args):
            odds = np.array(args.to_py())
            pi = 1 / odds

            implied_probabilities = pi + 1 / odds.shape[1] * (1 - np.sum(pi, axis=1, keepdims=True))

            return implied_probabilities


        def calculate_power_probability(args):
            odds = np.array(args.to_py())
            pi = 1 / odds

            k_opt = bisect(_get_power_normalization, 0, 100, args=(pi))
            implied_probabilities = pi ** k_opt

            return implied_probabilities


        def calculate_shin_probability(args):
            odds = np.array(args.to_py())
            pi = 1 / odds

            z_opt = bisect(_get_shin_normalization, 0, 10, args=(pi))
            implied_probabilities = _get_shin_implied_probabilities(z_opt, pi)

            return implied_probabilities

        
        def american_to_decimal(american_odds):
            if american_odds > 0:
                return (american_odds / 100) + 1
            else:
                return 100 / (-american_odds) + 1

        
        def decimal_to_american(decimal):
            if decimal <= 2:
                return (-100 / (decimal - 1))
            else:
                return (100 * (decimal - 1))

        
        def percent_to_american(percent):
            decimal = 1 / percent
            return decimal_to_american(decimal)


        def calculate_product(percent):
            percentNp = np.array(percent.to_py())
            decimal = 1 / percentNp
            firsts = decimal[:, 0]
            result = np.prod(firsts)
            return result

        def calculate_juice(decimal):
            decimalNp = np.array(decimal.to_py())
            percent = 1 / decimalNp
            juice = np.sum(percent, axis=1)
            return juice

        def v_american_to_decimal(american_odds):
            result = np.vectorize(american_to_decimal)(np.asarray(american_odds.to_py()))
            return result


        def v_decimal_to_american(decimal):
            result = np.vectorize(decimal_to_american)(np.asarray(decimal.to_py()))
            return result


        def v_percent_to_american(percent):
            result = np.vectorize(percent_to_american)(np.asarray(percent.to_py()))
            #result = (np.rint(result)).astype(int)
            return result


        def hello_world():
            print('Hello, World from pyscript!')


        def data_test(*args):
            print(args)

    </py-script>

    <div class="container-fluid">
        <div class="row">
            <div class="col">
                <label for="bankroll">Bankroll:
                    <input type="number" id="bankroll" name="bankroll">
                </label>
            </div>
        </div>
    
        <br />
    
        <div class="row">
            <div class="col">
                <div>
                    <textarea id="gridBuilderTextArea" rows="5" cols="50"></textarea>
                </div>
            </div>
        </div>
    
        <br />
        <div>
            <button id="helloWorldButton">Hello World</button>
        </div>
        <br />
        <div>
            <button id="testTextAreaButton">Test TextArea Data</button>
        </div>
        <div>
            <button id="testOddsButton">Test Odds Data</button>
        </div>
        <div>
            <button id="testCalculationsButton">Test Calculations</button>
        </div>
        <br />
        <div>
            <button id="buildTableButton">Build Table</button>
        </div>
        <br />
        <div>
            <button id="calculateButton">Calculate</button>
        </div>
    </div>

    <br />
    <div id="allContainer">
        <!--<div class="eventContainer" id="20230607-1">
            <div>
                <div class="userInput fst-italic" contenteditable="true" data-text="Book"></div>
                <div class="userInput fst-italic" contenteditable="true" data-text="Boost Description..."></div>
            </div>
            <div>
                <div class="fw-bold mx-2">Odds</div>
                <div class="legGrouping">
                    <div class="userInput" contenteditable="true" data-text="Leg1A"></div>
                    <div class="userInput" contenteditable="true" data-text="Leg1B"></div>
                </div>
                <div class="legGrouping">
                    <div class="userInput" contenteditable="true" data-text="Leg2A"></div>
                    <div class="userInput" contenteditable="true" data-text="Leg2B"></div>
                </div>
                <div class="legGrouping">
                    <div class="userInput" contenteditable="true" data-text="Leg3A"></div>
                    <div class="userInput" contenteditable="true" data-text="Leg3B"></div>
                </div>
                <div class="finalGrouping">
                    <div class="fw-bold">Final</div>
                    <div class="userInput" contenteditable="true" data-text="Boosted"></div>
                </div>
            </div>
            <p>
                Multiplicative:<br />
                Leg#1 (159); Market Juice = 2.1 %; Fair Value = +164 (37.8 %)<br />
                Leg#2 (-138); Market Juice = 2.0 %; Fair Value = -132 (56.8 %)<br />
                Leg#3 (-143); Market Juice = 2.0 %; Fair Value = -137 (57.7 %)<br />
                Final Odds (+835); Î£(Market Juice) = 6.10 %; Fair Value = +706 (12.4 %)<br />
                Summary; EV% = 16.0 %, Kelly Wager = $4.78 (Full=1.91u, 1/2=0.96u, 1/4=0.48u, FB = 103.6 %)
            </p>
        </div>-->
    </div>

    <!--
        for UX might be better to have inputs all gruped up at the top and then print all results as text
        this maybe can be simpler just rows of text
        <div>
            <div class="fw-bold">Multi</div>
            <div class="devigCalculations">LegDV</div>
            <div class="devigCalculations">Leg%</div>
            <div class="devigCalculations">LegDV</div>
            <div class="devigCalculations">Leg%</div>
            <div class="devigCalculations">Leg</div>
            <div class="devigCalculations">Leg%</div>
            <div class="devigCalculations">FinalDev</div>
        </div>
        <div>
            <div>Juice = 2.1%, 2.0%, 2.0%; Total = 6.10%;</div>
        </div>
        <div>
            <div>EV% 16.0%; Kelly Wager = $4.78 (Full=1.91u, 1/2=0.96u, 1/4=0.48u)</div>
        </div>
        
    -->

    <!-- Click this button to log 'Apple', 'Banana', 'Candy', 'Donut' by sorting in Python-->
     <!-- <button onclick="sortInPython(['Candy', 'Donut', 'Apple', 'Banana'])">Sort In Python And Log</button>
     <script>
         function sortInPython(data){
             js_sorted = pyscript.interpreter.globals.get('sorted') //grab python's 'sorted' function
             const sorted_data = js_sorted(data) //apply the function to the 'data' argument
             for (const item of sorted_data){
                 console.log(item)
             }
             hello_world = pyscript.interpreter.globals.get("hello_world"); 
             hello_world();
         }
     </script> -->

</body>

</html>